pipeline {
    agent {
        kubernetes {
            label 'k8s-deployer'
            defaultContainer 'deploy'
            yaml """
apiVersion: v1
kind: Pod
spec:
  serviceAccountName: jenkins
  nodeSelector:
    node-role.kubernetes.io/control-plane: ""
  tolerations:
  - key: "node-role.kubernetes.io/control-plane"
    operator: "Exists"
    effect: "NoSchedule"  
  containers:
  - name: deploy
    image: nazman/k8s-deployer:latest
    command:
    - cat
    tty: true
"""
        }
    }

    options {
        skipDefaultCheckout(true)
    }


    parameters {
        booleanParam(
            name: 'FORCE_DEPLOY',
            defaultValue: false,
            description: 'Force deployment ignoring changeset'
        )

        choice(
            name: 'DEPLOY_TARGET',
            choices: ['single', 'all'],
            description: 'Deploy to one cluster or all clusters'
        )

        choice(
            name: 'CLUSTER',
            choices: ['cloud', 'onprem'],
            description: 'Cluster to deploy (used if single selected)'
        )
    }

    environment {
        DEPLOYMENT_DIR = "${params.DEPLOYMENT_DIR}"
    }

    stages {

        stage('Checkout') {
            steps {
                container('deploy') {
                    git branch: 'main',
                        url: 'https://github.com/nazmang/k8s.git'
                }
            }
        }

        stage('Deploy') {
            when {
                    anyOf {
                        changeset "**/${env.DEPLOYMENT_DIR}/**"
                        expression { return params.FORCE_DEPLOY }
                    }
            }
            steps {
                
                script {

                    def clusterMap = [
                        "cloud": [
                            credential: "kubeconfig-hetzner",
                            overlay: "overlays/cloud",
                            critical: true
                        ],
                        "onprem": [
                            credential: "kubeconfig-onprem",
                            overlay: "overlays/onprem",
                            critical: false
                        ]
                    ]

                    def targets = params.DEPLOY_TARGET == "all" ?
                                  clusterMap.keySet() :
                                  [params.CLUSTER]

                    parallel targets.collectEntries { c ->

                        ["Deploy to ${c}": {

                            container('deploy') {

                                def cfg = clusterMap[c]

                                withCredentials([
                                    file(credentialsId: cfg.credential, variable: 'KUBECONFIG')
                                ]) {

                                    try {

                                        echo "Checking connectivity to ${c}..."

                                        sh """
                                            kubectl cluster-info
                                        """

                                        echo "Applying kustomize for ${c}..."

                                        sh """
                                            kubectl apply -k ${DEPLOYMENT_DIR}/${cfg.overlay}
                                        """

                                        echo "Deployment to ${c} completed."

                                    } catch (err) {

                                        if (cfg.critical) {
                                            error("Critical cluster ${c} failed. Stopping pipeline.")
                                        } else {
                                            echo "Non-critical cluster ${c} unreachable. Skipping."
                                        }
                                    }
                                }
                            }
                        }]
                    }
                }
            }
        }
    }
}
